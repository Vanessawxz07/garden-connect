# 用户中心隐私设置需求 PRD

## 一、需求概述

### 1.1 需求背景
- 当前用户中心仅支持用户查看自己的个人信息，功能单一
- 缺乏社交属性，无法查看其他用户主页
- 缺乏隐私控制功能，不符合隐私合规要求
- 需要增加更丰富的内容展示模块

### 1.2 需求目标
- **社交化**：支持用户访问其他用户主页，建立关注关系
- **隐私保护**：提供细粒度的隐私设置，用户可自主控制信息可见性
- **内容丰富**：增加多个内容展示模块（动态、交易、收藏、宠物图鉴）
- **合规性**：符合GDPR/PIPL等隐私法规要求，确保用户知情同意

---

## 二、用户角色与视图定义

### 2.1 主人态（Owner View）
- **路由**：`/profile`
- **访问权限**：仅用户本人
- **主要操作**：查看完整个人信息、编辑资料、设置隐私权限、查看私密内容
- **主按钮**：「设置」按钮（右上角）

### 2.2 访客态（Visitor View）
- **路由**：`/user/:userId`
- **访问权限**：所有用户（根据隐私设置控制可见内容）
- **主要操作**：查看公开信息、关注/取消关注用户
- **主按钮**：「关注」/「已关注」按钮（右上角）

### 2.3 自己的访客态（Self-Visitor View）
- **路由**：`/user/:userId`（自己的userId）
- **表现形式**：与主人态一致，显示「设置」按钮
- **说明**：当用户访问 `/user/自己的ID` 时，展示与 `/profile` 相同的内容和权限

---

## 三、页面布局与模块设计

### 3.1 页面整体布局

```
┌─────────────────────────────────────────────────────┐
│  Navigation Bar                        [设置]/[关注]  │
├─────────────────────────────────────────────────────┤
│                                                       │
│  ┌─────────────────────────────────────────────┐   │
│  │         个人信息头部区域                       │   │
│  │  ┌──────┐                                    │   │
│  │  │ 头像  │  用户名                 标签1 标签2  │   │
│  │  │ 88x88│  @username                         │   │
│  │  └──────┘  个人简介...                        │   │
│  │                                               │   │
│  │  关注 120  |  粉丝 340  |  注册时间 2024-01  │   │
│  │  在线状态：● 当前在线                          │   │
│  └─────────────────────────────────────────────┘   │
│                                                       │
│  ┌─────────────────────────────────────────────┐   │
│  │ Tab导航                                       │   │
│  │ [动态] [交易记录] [收藏] [宠物图鉴]             │   │
│  ├─────────────────────────────────────────────┤   │
│  │                                               │   │
│  │         Tab内容区域                            │   │
│  │                                               │   │
│  └─────────────────────────────────────────────┘   │
│                                                       │
└─────────────────────────────────────────────────────┘
```

### 3.2 个人信息头部区域

#### 3.2.1 头像
- **尺寸**：88x88px，圆形
- **主人态**：可点击更换头像（V2迭代）
- **访客态**：仅展示，不可交互
- **默认头像**：使用用户名首字母作为fallback

#### 3.2.2 用户名与用户ID
- **用户名**：大号字体，粗体，显示在头像右侧
- **用户ID**：`@username` 格式，用户名下方，较小字体，灰色
- **可见性**：始终公开，不受隐私设置控制

#### 3.2.3 用户标签
- **位置**：用户名右侧
- **样式**：圆角徽章，不同颜色区分标签类型
- **类型示例**：
  - VIP用户（金色）
  - 活跃用户（蓝色）
  - 认证用户（绿色）
  - 新手（灰色）
- **来源**：由运营在后台为指定用户打标（非用户自定义）
- **数据库设计**：`user_tags` 表，字段包含 `user_id`, `tag_name`, `tag_color`, `tag_icon`
- **可见性**：可在隐私设置中控制是否显示
- **V2迭代**：支持数据驱动的机制化标签（如：交易次数达标、登录天数等）

#### 3.2.4 个人简介
- **位置**：用户名/标签下方
- **字数限制**：最多200字符
- **主人态**：显示编辑按钮（V2迭代）
- **访客态**：仅展示
- **可见性**：可在隐私设置中控制是否显示
- **默认值**：空时显示"这个人很懒，什么都没写~"（仅主人态可见）

#### 3.2.5 统计数据
**关注数**
- **显示格式**：`关注 120`
- **点击行为**：跳转到关注列表页（V2迭代）
- **可见性**：可在隐私设置中控制是否显示

**粉丝数**
- **显示格式**：`粉丝 340`
- **点击行为**：跳转到粉丝列表页（V2迭代）
- **可见性**：可在隐私设置中控制是否显示

**注册时间**
- **显示格式**：`注册时间 2024-01`（精确到月）
- **可见性**：可在隐私设置中控制是否显示

#### 3.2.6 在线状态
- **显示格式**：`● 当前在线` / `○ 离线`
- **在线判定**：
  - 用户在15分钟内有活动行为视为在线
  - 使用心跳机制更新在线状态
- **可见性**：可在隐私设置中控制是否显示
- **偏好在线时间**（V2迭代）：用户可设置常在线时间段，如"通常在线时间：19:00-23:00"

### 3.3 Tab导航设计

#### 3.3.1 Tab列表
1. **动态**（本次实现）
2. **交易记录**（本次占位）
3. **收藏**（V2迭代，本次占位）
4. **宠物图鉴**（V2迭代，本次占位）

#### 3.3.2 Tab样式
- **未选中态**：灰色文字，无下划线
- **选中态**：主题色文字，底部有2px下划线
- **Hover态**：文字颜色加深，光标变为pointer
- **移动端适配**：支持横向滑动切换

#### 3.3.3 Tab权限说明
每个Tab在隐私设置中都有独立的可见性控制：
- **仅自己可见**：只有主人态可查看
- **关注的人可见**：关注者和主人态可查看
- **所有人可见**：所有访客都可查看

---

## 四、Tab内容模块详细设计

### 4.1 动态 Tab（本次实现）

#### 4.1.1 内容说明
展示用户发起的所有抽奖活动（Giveaways）

#### 4.1.2 数据来源
- 查询 `giveaways` 表，`vip_user_id` = 当前profile的用户ID
- 按创建时间倒序排列

#### 4.1.3 展示内容
- 使用现有的 `GiveawayCard` 组件
- 卡片布局：网格布局，响应式
  - 桌面端：每行3个卡片
  - 平板端：每行2个卡片
  - 移动端：每行1个卡片
- 支持分页或无限滚动加载

#### 4.1.4 空状态
- **主人态**：显示"你还没有发起过任何抽奖活动"，提供「创建抽奖」按钮（若有VIP权限）
- **访客态**：显示"该用户还没有发起过任何抽奖活动"

#### 4.1.5 默认隐私设置
- **默认**：所有人可见
- **可配置**：在隐私设置中修改为「仅自己」或「关注的人」

#### 4.1.6 访客态访问被限制时的展示
- 显示锁定图标🔒
- 提示文案："该内容仅对[关注的人/本人]可见"
- 如果是「关注的人可见」，显示「关注Ta以查看」按钮

### 4.2 交易记录 Tab（本次占位）

#### 4.2.1 内容说明
展示用户的Roblox道具交易记录（买入/卖出/交换）

#### 4.2.2 占位实现
- 显示"功能开发中，敬请期待"
- 展示一个空状态插图

#### 4.2.3 默认隐私设置
- **默认**：仅自己可见
- **原因**：交易记录涉及敏感信息，默认私密

#### 4.2.4 V2迭代规划
- 展示交易列表：道具图标、名称、交易类型、交易时间、交易对方、金额
- 支持筛选：交易类型、时间范围、道具类型
- 支持搜索：根据道具名称或交易对方搜索
- 数据来源：需新建 `trade_records` 表

### 4.3 收藏 Tab（本次占位）

#### 4.3.1 内容说明
展示用户收藏的抽奖活动或道具

#### 4.3.2 占位实现
- 显示"功能开发中，敬请期待"

#### 4.3.3 默认隐私设置
- **默认**：仅自己可见

#### 4.3.4 V2迭代规划
- 支持收藏抽奖活动和道具
- 网格布局展示收藏内容
- 数据来源：需新建 `user_favorites` 表

### 4.4 宠物图鉴 Tab（本次占位）

#### 4.4.1 内容说明
展示用户在Roblox中拥有的宠物图鉴

#### 4.4.2 占位实现
- 显示"功能开发中，敬请期待"

#### 4.4.3 默认隐私设置
- **默认**：关注的人可见

#### 4.4.4 V2迭代规划
- 展示宠物卡片：宠物图标、名称、稀有度、获得时间
- 支持筛选：稀有度、宠物类型
- 数据来源：需新建 `user_pets` 表

---

## 五、关注功能详细设计

### 5.1 关注按钮

#### 5.1.1 按钮位置
- 页面右上角，与导航栏同行
- 在访客态时显示

#### 5.1.2 按钮状态
**未关注状态**
- 文案：「关注」
- 样式：主题色背景，白色文字
- 图标：`UserPlus` icon

**已关注状态**
- 文案：「已关注」
- 样式：次要背景色，主题色边框，主题色文字
- 图标：`UserCheck` icon
- Hover时显示：「取消关注」

**加载状态**
- 文案：「处理中...」
- 按钮禁用，显示loading spinner

#### 5.1.3 关注/取消关注交互
1. 点击「关注」按钮
2. 按钮进入加载状态
3. 发送关注请求到后端
4. 成功后：
   - 按钮状态变为「已关注」
   - 用户的粉丝数+1
   - 当前访客的关注数+1
   - Toast提示："已关注 @username"
5. 失败时：
   - 显示错误Toast
   - 按钮恢复到「关注」状态

#### 5.1.4 取消关注确认
- Hover「已关注」按钮时，文案变为「取消关注」，背景变红色
- 点击后弹出确认对话框：
  - 标题："确认取消关注 @username？"
  - 说明："取消关注后，你将无法查看Ta的部分私密内容"
  - 按钮：「确认取消」（destructive样式）、「我再想想」
- 确认后执行取消关注操作

### 5.2 数据库设计

#### 5.2.1 user_follows 表（已存在）
```sql
CREATE TABLE user_follows (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  follower_id uuid NOT NULL, -- 关注者ID
  following_id uuid NOT NULL, -- 被关注者ID
  created_at timestamptz DEFAULT now(),
  UNIQUE(follower_id, following_id) -- 防止重复关注
);
```

#### 5.2.2 RLS策略
- 所有人可查看关注关系（SELECT）
- 仅关注者本人可创建关注关系（INSERT）
- 仅关注者本人可删除关注关系（DELETE）

### 5.3 关注数/粉丝数计算
- **实时计算**：查询时统计 `user_follows` 表
- **缓存优化**（V2）：在 `profiles` 表中增加 `follower_count` 和 `following_count` 字段，通过触发器自动更新

---

## 六、隐私设置功能详细设计

### 6.1 设置入口

#### 6.1.1 入口位置
- 主人态页面右上角「设置」按钮
- 点击后跳转到 `/settings/privacy` 页面

#### 6.1.2 设置按钮样式
- 图标：`Settings` icon
- 样式：次要按钮样式
- Hover效果：背景色加深

### 6.2 隐私设置页面布局

```
┌─────────────────────────────────────────────────────┐
│  ← 返回个人中心           隐私设置                     │
├─────────────────────────────────────────────────────┤
│                                                       │
│  ┌─────────────────────────────────────────────┐   │
│  │ 主页可见性                                    │   │
│  │ ○ 所有人可见                                  │   │
│  │ ○ 仅关注的人可见                              │   │
│  │ ● 仅自己可见（私密）                          │   │
│  └─────────────────────────────────────────────┘   │
│                                                       │
│  ┌─────────────────────────────────────────────┐   │
│  │ 个人信息可见性                                │   │
│  │                                               │   │
│  │ 注册时间         [所有人可见 ▼]               │   │
│  │ 关注/粉丝数      [所有人可见 ▼]               │   │
│  │ 用户标签         [所有人可见 ▼]               │   │
│  │ 个人简介         [所有人可见 ▼]               │   │
│  └─────────────────────────────────────────────┘   │
│                                                       │
│  ┌─────────────────────────────────────────────┐   │
│  │ 内容模块可见性                                │   │
│  │                                               │   │
│  │ 动态             [所有人可见 ▼]               │   │
│  │ 交易记录         [仅自己可见 ▼]               │   │
│  │ 收藏             [仅自己可见 ▼]               │   │
│  │ 宠物图鉴         [关注的人可见 ▼]             │   │
│  └─────────────────────────────────────────────┘   │
│                                                       │
│  ┌─────────────────────────────────────────────┐   │
│  │ 在线状态设置                                  │   │
│  │                                               │   │
│  │ 显示在线状态     [开关切换]                   │   │
│  │                                               │   │
│  └─────────────────────────────────────────────┘   │
│                                                       │
│              [保存设置]                               │
│                                                       │
└─────────────────────────────────────────────────────┘
```

### 6.3 隐私设置项详细说明

#### 6.3.1 主页可见性（全局设置）
- **选项**：
  1. **所有人可见**：任何人都可以访问你的主页
  2. **仅关注的人可见**：只有关注你的人可以访问你的主页
  3. **仅自己可见（私密）**：只有你自己可以访问
- **默认值**：所有人可见
- **说明文案**："控制谁可以查看你的个人主页"
- **限制访问提示**：当访客无权限访问时，显示：
  - 403页面
  - 提示："该用户的主页为私密状态"或"该主页仅对关注者可见"
  - 如果是「仅关注的人可见」，显示「关注Ta以查看」按钮

#### 6.3.2 个人信息可见性（细粒度设置）

**注册时间**
- **选项**：所有人可见 / 关注的人可见 / 仅自己可见
- **默认值**：所有人可见

**关注/粉丝数**
- **选项**：所有人可见 / 关注的人可见 / 仅自己可见
- **默认值**：所有人可见
- **注意**：当设置为「仅自己可见」时，数字显示为"***"

**用户标签**
- **选项**：所有人可见 / 关注的人可见 / 仅自己可见
- **默认值**：所有人可见

**个人简介**
- **选项**：所有人可见 / 关注的人可见 / 仅自己可见
- **默认值**：所有人可见

#### 6.3.3 内容模块可见性

**动态**
- **选项**：所有人可见 / 关注的人可见 / 仅自己可见
- **默认值**：所有人可见

**交易记录**
- **选项**：所有人可见 / 关注的人可见 / 仅自己可见
- **默认值**：仅自己可见（敏感信息）

**收藏**
- **选项**：所有人可见 / 关注的人可见 / 仅自己可见
- **默认值**：仅自己可见

**宠物图鉴**
- **选项**：所有人可见 / 关注的人可见 / 仅自己可见
- **默认值**：关注的人可见

#### 6.3.4 在线状态设置

**显示在线状态**
- **类型**：开关切换（Switch）
- **默认值**：开启
- **说明文案**："关闭后，其他用户将无法看到你的在线状态"

**偏好在线时间**（V2迭代）
- **类型**：时间段选择器
- **示例**：19:00-23:00
- **说明文案**："设置你通常在线的时间段，方便其他用户知道何时能找到你"

### 6.4 数据库设计

#### 6.4.1 user_privacy_settings 表（新建）
```sql
CREATE TABLE user_privacy_settings (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid UNIQUE NOT NULL,
  
  -- 全局可见性
  profile_visibility text DEFAULT 'public', -- 'public', 'followers', 'private'
  
  -- 个人信息可见性
  registration_time_visibility text DEFAULT 'public',
  follower_count_visibility text DEFAULT 'public',
  user_tags_visibility text DEFAULT 'public',
  bio_visibility text DEFAULT 'public',
  
  -- 内容模块可见性
  activity_visibility text DEFAULT 'public',
  trade_history_visibility text DEFAULT 'private',
  favorites_visibility text DEFAULT 'private',
  pet_album_visibility text DEFAULT 'followers',
  
  -- 在线状态
  show_online_status boolean DEFAULT true,
  preferred_online_time text DEFAULT NULL, -- V2: '19:00-23:00'
  
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

-- 触发器：自动更新 updated_at
CREATE TRIGGER update_user_privacy_settings_updated_at
  BEFORE UPDATE ON user_privacy_settings
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();
```

#### 6.4.2 user_tags 表（新建）
```sql
CREATE TABLE user_tags (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  tag_name text NOT NULL,
  tag_color text DEFAULT 'blue', -- 标签颜色
  tag_icon text DEFAULT NULL, -- 图标名称（可选）
  created_at timestamptz DEFAULT now(),
  created_by uuid NOT NULL -- 创建者（运营人员ID）
);

-- 索引
CREATE INDEX idx_user_tags_user_id ON user_tags(user_id);
```

#### 6.4.3 profiles 表（扩展）
需要在现有 `profiles` 表中增加字段（如果不存在）：
```sql
ALTER TABLE profiles ADD COLUMN IF NOT EXISTS bio text;
ALTER TABLE profiles ADD COLUMN IF NOT EXISTS avatar_url text;
ALTER TABLE profiles ADD COLUMN IF NOT EXISTS last_active_at timestamptz DEFAULT now();
```

### 6.5 隐私设置初始化

#### 6.5.1 新用户注册时
- 自动创建 `user_privacy_settings` 记录，使用默认值
- 通过数据库触发器实现：
```sql
CREATE OR REPLACE FUNCTION init_user_privacy_settings()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO user_privacy_settings (user_id)
  VALUES (NEW.id);
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER on_user_created_init_privacy
  AFTER INSERT ON auth.users
  FOR EACH ROW
  EXECUTE FUNCTION init_user_privacy_settings();
```

#### 6.5.2 老用户迁移
- 对于现有用户，在首次访问设置页面时自动创建默认隐私设置
- 或通过迁移脚本批量创建

### 6.6 隐私设置保存

#### 6.6.1 保存按钮
- 位置：页面底部居中
- 样式：主要按钮样式
- 文案：「保存设置」
- 禁用条件：设置未变更时禁用

#### 6.6.2 保存流程
1. 点击「保存设置」按钮
2. 按钮进入加载状态：「保存中...」
3. 发送更新请求到后端
4. 成功后：
   - Toast提示："隐私设置已保存"
   - 2秒后自动返回个人中心
5. 失败时：
   - 显示错误Toast："保存失败，请重试"
   - 按钮恢复到「保存设置」状态

---

## 七、首次更新通知与合规设计

### 7.1 通知触发时机
- 用户在本次功能上线后首次登录时触发
- 使用 `localStorage` 或数据库字段记录用户是否已查看通知
- 显示次数：最多2次
  - 第1次：首次登录时弹出
  - 第2次：第2次登录时弹出（如果第1次点击了"稍后再说"）
  - 如果用户两次都点击"稍后再说"，则不再主动弹窗

### 7.2 通知弹窗设计

#### 7.2.1 弹窗样式
- 类型：模态对话框（Modal Dialog）
- 尺寸：中等大小（max-width: 500px）
- 遮罩：半透明黑色背景
- 位置：屏幕居中
- 关闭方式：
  - 点击按钮
  - 不支持点击遮罩或ESC关闭（确保用户知情）

#### 7.2.2 弹窗内容

```
┌───────────────────────────────────────────────┐
│                    ✨                          │
│           个人主页全新升级！                   │
│                                                │
│   你的个人主页现在更加丰富和社交化了！          │
│                                                │
│   新功能亮点：                                 │
│   🔹 支持其他用户访问你的主页                  │
│   🔹 关注功能，与好友建立连接                  │
│   🔹 展示你的动态、交易和收藏                  │
│   🔹 细粒度的隐私控制，保护你的信息            │
│                                                │
│   隐私提醒：                                   │
│   为了保护你的隐私，我们为你设置了默认的       │
│   隐私选项。你可以随时在设置中调整：           │
│   • 交易记录默认仅自己可见                     │
│   • 你可以自主控制每项信息的可见范围           │
│                                                │
│   ┌─────────────────┐  ┌──────────────────┐  │
│   │   前往设置       │  │   稍后再说        │  │
│   └─────────────────┘  └──────────────────┘  │
│                                                │
│              了解更多 >                         │
└───────────────────────────────────────────────┘
```

#### 7.2.3 按钮说明

**前往设置**
- 样式：主要按钮（Primary）
- 行为：
  - 关闭弹窗
  - 跳转到 `/settings/privacy` 页面
  - 记录用户已查看通知（不再重复显示）

**稍后再说**
- 样式：次要按钮（Secondary）
- 行为：
  - 关闭弹窗
  - 增加查看次数计数
  - 如果查看次数 < 2，下次登录时再次显示
  - 如果查看次数 >= 2，不再显示

**了解更多**
- 样式：文本链接
- 行为：
  - 打开帮助文档页面（新标签页）
  - 弹窗保持打开状态

### 7.3 数据存储方案

#### 7.3.1 方案一：LocalStorage（推荐用于本次实现）
```typescript
// 数据结构
{
  "profile_update_notification_v1": {
    "viewCount": 1, // 查看次数
    "lastViewedAt": "2024-11-30T12:00:00Z",
    "dismissed": false // 用户是否点击了"前往设置"
  }
}
```

**优点**：
- 实现简单，无需数据库迁移
- 性能好，不增加服务器负担

**缺点**：
- 清除浏览器数据会重置
- 无法跨设备同步

#### 7.3.2 方案二：数据库字段（V2迭代考虑）
在 `profiles` 表中增加字段：
```sql
ALTER TABLE profiles ADD COLUMN IF NOT EXISTS 
  profile_update_notification_view_count integer DEFAULT 0;
ALTER TABLE profiles ADD COLUMN IF NOT EXISTS 
  profile_update_notification_dismissed boolean DEFAULT false;
```

**优点**：
- 跨设备同步
- 数据持久化

**缺点**：
- 需要数据库迁移
- 增加查询开销

### 7.4 隐私合规说明

#### 7.4.1 合规原则
- **知情同意**：通过弹窗明确告知用户新功能和隐私设置
- **数据最小化**：敏感信息（如交易记录）默认仅自己可见
- **用户控制**：提供细粒度的隐私设置，用户可自主选择
- **透明度**：在设置页面提供清晰的说明文案
- **数据访问权**：用户可随时查看和修改自己的隐私设置

#### 7.4.2 设置页面合规文案
在隐私设置页面顶部增加说明卡片：

```
ℹ️ 隐私说明
我们尊重你的隐私，并为你提供完全的控制权。
你可以自主选择每项信息的可见范围，我们不会未经你的同意分享你的个人信息。
敏感信息（如交易记录）默认为私密状态，只有你自己可见。
```

#### 7.4.3 每个设置项的说明文案
在每个设置项下方增加简短说明（灰色小字）：
- **注册时间**："让其他用户了解你加入社区的时间"
- **关注/粉丝数**："展示你的社交连接，隐藏后显示为***"
- **用户标签**："展示你获得的成就和身份标识"
- **个人简介**："让其他用户更了解你"
- **动态**："你发起的抽奖活动"
- **交易记录**："你的道具交易历史，涉及敏感信息，建议仅自己可见"
- **收藏**："你收藏的内容"
- **宠物图鉴**："你拥有的宠物收藏"

---

## 八、路由设计

### 8.1 路由列表
| 路由 | 说明 | 访问权限 |
|------|------|---------|
| `/profile` | 个人中心（主人态） | 仅登录用户本人 |
| `/user/:userId` | 用户主页（访客态/主人态） | 根据隐私设置控制 |
| `/settings/privacy` | 隐私设置页面 | 仅登录用户本人 |

### 8.2 路由跳转逻辑

#### 8.2.1 `/profile` 路由
- 未登录用户访问：重定向到 `/login`
- 已登录用户访问：展示主人态页面

#### 8.2.2 `/user/:userId` 路由
- 检查 `userId` 是否为当前登录用户
  - 是：展示主人态（与 `/profile` 相同）
  - 否：根据隐私设置展示访客态或403页面

#### 8.2.3 隐私权限检查流程
```
访问 /user/:userId
    ↓
是否为本人？
    ↓ 是
  展示主人态
    ↓ 否
查询目标用户的隐私设置
    ↓
profile_visibility = ?
    ↓ public
  展示访客态（所有公开内容）
    ↓ followers
  当前用户是否关注目标用户？
    ↓ 是
  展示访客态（关注者可见内容）
    ↓ 否
  显示403页面 + "关注Ta以查看"按钮
    ↓ private
  显示403页面 + "该用户主页为私密状态"
```

---

## 九、前后端交互设计

### 9.1 API接口列表

#### 9.1.1 获取用户主页信息
```
GET /api/user/:userId/profile

Response:
{
  "user": {
    "id": "uuid",
    "username": "string",
    "email": "string",
    "avatar_url": "string",
    "bio": "string",
    "created_at": "timestamp",
    "last_active_at": "timestamp"
  },
  "tags": [
    { "name": "VIP", "color": "gold", "icon": "crown" }
  ],
  "stats": {
    "follower_count": 340,
    "following_count": 120
  },
  "privacy": {
    "profile_visibility": "public",
    "registration_time_visibility": "public",
    ...
  },
  "isOwner": boolean,
  "isFollowing": boolean,
  "canView": {
    "profile": boolean,
    "registration_time": boolean,
    "follower_count": boolean,
    "activity": boolean,
    "trade_history": boolean,
    ...
  }
}
```

#### 9.1.2 获取用户动态
```
GET /api/user/:userId/activity?page=1&limit=12

Response:
{
  "giveaways": [...],
  "total": 50,
  "page": 1,
  "limit": 12,
  "hasMore": boolean
}
```

#### 9.1.3 关注/取消关注用户
```
POST /api/user/:userId/follow
DELETE /api/user/:userId/follow

Response:
{
  "success": boolean,
  "isFollowing": boolean,
  "follower_count": 341
}
```

#### 9.1.4 获取隐私设置
```
GET /api/user/privacy-settings

Response:
{
  "profile_visibility": "public",
  "registration_time_visibility": "public",
  ...
}
```

#### 9.1.5 更新隐私设置
```
PUT /api/user/privacy-settings

Body:
{
  "profile_visibility": "followers",
  "trade_history_visibility": "private",
  ...
}

Response:
{
  "success": boolean,
  "settings": {...}
}
```

### 9.2 权限验证逻辑

#### 9.2.1 后端权限验证
所有涉及隐私的接口都需要在后端进行权限验证：

```typescript
function canViewField(
  targetUserId: string,
  viewerId: string | null,
  fieldVisibility: 'public' | 'followers' | 'private',
  isFollowing: boolean
): boolean {
  // 本人永远可见
  if (targetUserId === viewerId) return true;
  
  // 公开可见
  if (fieldVisibility === 'public') return true;
  
  // 仅关注者可见
  if (fieldVisibility === 'followers') {
    return viewerId !== null && isFollowing;
  }
  
  // 私密
  return false;
}
```

#### 9.2.2 RLS策略
使用Supabase的Row Level Security确保数据安全：

```sql
-- user_privacy_settings 表
-- 仅用户本人可查看和修改自己的隐私设置
CREATE POLICY "Users can view their own privacy settings"
  ON user_privacy_settings FOR SELECT
  USING (auth.uid() = user_id);

CREATE POLICY "Users can update their own privacy settings"
  ON user_privacy_settings FOR UPDATE
  USING (auth.uid() = user_id);
```

---

## 十、样式与交互细节

### 10.1 响应式设计

#### 10.1.1 断点
- **移动端**：< 768px
- **平板端**：768px - 1024px
- **桌面端**：> 1024px

#### 10.1.2 布局适配
**移动端**
- 头像尺寸：64x64px
- Tab导航：支持横向滑动
- 动态卡片：每行1个
- 设置页面：单列布局

**平板端**
- 头像尺寸：80x80px
- 动态卡片：每行2个
- 设置页面：单列布局

**桌面端**
- 头像尺寸：88x88px
- 动态卡片：每行3个
- 设置页面：双列布局（左侧导航，右侧内容）（V2）

### 10.2 动画效果

#### 10.2.1 页面过渡
- 页面切换：淡入淡出（300ms）
- Tab切换：滑动切换（200ms）

#### 10.2.2 按钮交互
- Hover：背景色加深（150ms）
- 点击：按下效果（scale: 0.98）（100ms）
- 加载状态：Spinner旋转动画

#### 10.2.3 弹窗动画
- 弹出：从中心放大 + 淡入（250ms）
- 关闭：缩小到中心 + 淡出（200ms）

### 10.3 色彩系统

#### 10.3.1 语义色彩
使用 Tailwind 语义化变量：
- **主题色**：`bg-primary`, `text-primary`
- **次要色**：`bg-secondary`, `text-secondary`
- **强调色**：`bg-accent`, `text-accent`
- **成功**：`bg-green-500`
- **警告**：`bg-yellow-500`
- **错误**：`bg-destructive`
- **背景**：`bg-background`
- **前景**：`text-foreground`
- **禁用**：`text-muted-foreground`

#### 10.3.2 用户标签色彩
- **VIP**：金色（`#FFD700`）
- **活跃**：蓝色（`#3B82F6`）
- **认证**：绿色（`#10B981`）
- **新手**：灰色（`#6B7280`）

### 10.4 加载状态

#### 10.4.1 骨架屏
在数据加载时显示骨架屏（Skeleton）：
- 个人信息区域：头像、用户名、统计数据的骨架
- 动态列表：卡片骨架，3个占位卡片

#### 10.4.2 加载指示器
- 按钮加载：Spinner + 文案变化
- 页面加载：顶部进度条
- 无限滚动：底部加载更多指示器

### 10.5 错误状态

#### 10.5.1 403权限错误
```
┌─────────────────────────────────────────────┐
│                                              │
│              🔒                              │
│                                              │
│         该内容暂不可见                        │
│                                              │
│    该用户的主页仅对[关注者/本人]可见         │
│                                              │
│         [关注Ta以查看主页]                   │
│                                              │
└─────────────────────────────────────────────┘
```

#### 10.5.2 404用户不存在
```
┌─────────────────────────────────────────────┐
│                                              │
│              😕                              │
│                                              │
│          用户不存在                           │
│                                              │
│     该用户可能已注销或ID输入错误              │
│                                              │
│         [返回首页]                            │
│                                              │
└─────────────────────────────────────────────┘
```

#### 10.5.3 网络错误
- Toast提示："网络连接失败，请检查网络后重试"
- 提供「重试」按钮

---

## 十一、测试用例设计

### 11.1 功能测试

#### 11.1.1 主人态访问
- [ ] 访问 `/profile`，正确展示个人信息
- [ ] 显示「设置」按钮
- [ ] 可以查看所有Tab内容（包括私密内容）
- [ ] 所有统计数据正确显示

#### 11.1.2 访客态访问
- [ ] 访问 `/user/:userId`（其他用户），正确展示公开信息
- [ ] 显示「关注」/「已关注」按钮
- [ ] 根据隐私设置隐藏不可见内容
- [ ] 点击关注按钮，关注成功

#### 11.1.3 隐私权限控制
- [ ] 设置 `profile_visibility` = 'private'，其他用户访问显示403
- [ ] 设置 `trade_history_visibility` = 'private'，其他用户看不到交易记录Tab内容
- [ ] 设置 `activity_visibility` = 'followers'，未关注用户看不到动态，关注后可见

#### 11.1.4 关注功能
- [ ] 点击「关注」，关注成功，按钮变为「已关注」
- [ ] Hover「已关注」，显示「取消关注」，点击弹出确认对话框
- [ ] 确认取消关注，成功取消，按钮变为「关注」
- [ ] 关注后，粉丝数+1，取消关注后粉丝数-1

#### 11.1.5 隐私设置
- [ ] 打开隐私设置页面，正确展示当前设置
- [ ] 修改设置后点击保存，成功保存并返回个人中心
- [ ] 修改设置后不保存直接离开，设置未生效

#### 11.1.6 首次更新通知
- [ ] 新用户首次登录，显示更新通知弹窗
- [ ] 点击「前往设置」，跳转到隐私设置页面，不再重复显示
- [ ] 点击「稍后再说」，关闭弹窗，下次登录再次显示
- [ ] 点击2次「稍后再说」后，不再显示弹窗

### 11.2 边界测试

#### 11.2.1 数据边界
- [ ] 用户无粉丝时，显示"粉丝 0"
- [ ] 用户无关注时，显示"关注 0"
- [ ] 用户无动态时，显示空状态
- [ ] 个人简介超过200字符时，截断显示

#### 11.2.2 权限边界
- [ ] 未登录用户访问 `/profile`，重定向到 `/login`
- [ ] 访问不存在的用户ID，显示404页面
- [ ] 自己关注自己，显示错误提示

#### 11.2.3 并发操作
- [ ] 同时点击多次「关注」按钮，只发送一次请求
- [ ] 在保存设置过程中刷新页面，设置正确保存或回滚

### 11.3 兼容性测试

#### 11.3.1 浏览器兼容
- [ ] Chrome（最新版）
- [ ] Firefox（最新版）
- [ ] Safari（最新版）
- [ ] Edge（最新版）

#### 11.3.2 设备兼容
- [ ] iPhone（Safari）
- [ ] Android（Chrome）
- [ ] iPad（Safari）
- [ ] 桌面端（各浏览器）

### 11.4 性能测试

#### 11.4.1 加载性能
- [ ] 首屏加载时间 < 2秒
- [ ] 动态列表首次加载 < 1秒
- [ ] Tab切换响应时间 < 300ms

#### 11.4.2 数据量测试
- [ ] 用户有1000+粉丝时，统计数据正确显示
- [ ] 用户有100+动态时，分页加载正常
- [ ] 用户有50+标签时，展示正常（限制最多显示5个，其他省略）

---

## 十二、迭代版本规划

### 12.1 V1.0（本次实现）✅
**目标**：建立基础的用户主页和隐私设置功能

**功能清单**：
- [x] 主人态页面（`/profile`）
- [x] 访客态页面（`/user/:userId`）
- [x] 个人信息头部区域（头像、用户名、标签、简介、统计数据、在线状态）
- [x] Tab导航（动态、交易记录、收藏、宠物图鉴）
- [x] **动态Tab**：展示用户发起的抽奖活动
- [x] **交易记录Tab**：占位状态
- [x] **收藏Tab**：占位状态
- [x] **宠物图鉴Tab**：占位状态
- [x] 关注/取消关注功能
- [x] 隐私设置页面（`/settings/privacy`）
- [x] 全局主页可见性设置
- [x] 个人信息细粒度可见性设置
- [x] 内容模块可见性设置
- [x] 在线状态显示开关
- [x] 首次更新通知弹窗（显示2次逻辑）
- [x] 权限验证（前端+后端+RLS）
- [x] 响应式设计
- [x] 用户标签系统（运营后台打标）

**数据库变更**：
- 新建 `user_privacy_settings` 表
- 新建 `user_tags` 表
- 扩展 `profiles` 表（`bio`, `avatar_url`, `last_active_at`）

### 12.2 V2.0（后续迭代）🔄

#### 12.2.1 交易记录Tab
- [ ] 展示用户的Roblox道具交易记录
- [ ] 支持筛选：交易类型、时间范围、道具类型
- [ ] 支持搜索：道具名称、交易对方
- [ ] 新建 `trade_records` 表

#### 12.2.2 收藏Tab
- [ ] 展示用户收藏的抽奖活动和道具
- [ ] 支持取消收藏
- [ ] 新建 `user_favorites` 表

#### 12.2.3 宠物图鉴Tab
- [ ] 展示用户拥有的Roblox宠物
- [ ] 支持筛选：稀有度、宠物类型
- [ ] 显示宠物获得时间和来源
- [ ] 新建 `user_pets` 表

#### 12.2.4 个人资料编辑
- [ ] 主人态可编辑头像
- [ ] 主人态可编辑个人简介
- [ ] 主人态可编辑用户名（限制频率）
- [ ] 头像上传到Supabase Storage

#### 12.2.5 关注列表
- [ ] 关注列表页面（`/user/:userId/following`）
- [ ] 粉丝列表页面（`/user/:userId/followers`）
- [ ] 支持在列表中关注/取消关注

#### 12.2.6 在线状态增强
- [ ] 偏好在线时间设置（时间段选择器）
- [ ] 展示"通常在线时间：19:00-23:00"
- [ ] 在线心跳机制优化

#### 12.2.7 通知偏好设置
- [ ] 设置页面增加「通知偏好」板块
- [ ] 控制接收哪些类型的通知（关注、点赞、评论等）
- [ ] 邮件通知开关

#### 12.2.8 用户标签增强
- [ ] 支持数据驱动的机制化标签（交易次数、登录天数等）
- [ ] 用户可选择展示哪些标签（如果有多个）
- [ ] 标签获得记录和说明

### 12.3 V3.0（未来规划）🚀

#### 12.3.1 社交功能增强
- [ ] 私信功能
- [ ] 评论功能（在动态下评论）
- [ ] 点赞功能
- [ ] 分享到社交媒体

#### 12.3.2 个人主页定制
- [ ] 主页主题色定制
- [ ] 主页背景图设置
- [ ] 主页布局自定义

#### 12.3.3 成就系统
- [ ] 成就徽章展示
- [ ] 成就获得记录
- [ ] 成就墙（展示所有成就）

#### 12.3.4 数据统计
- [ ] 个人主页访问统计
- [ ] 粉丝增长趋势图
- [ ] 动态互动数据分析

---

## 十三、附录

### 13.1 相关文档链接
- [抽奖功能PRD](./抽奖功能PRD.md)
- [用户认证流程文档](待补充)
- [隐私政策](待补充)

### 13.2 术语表
| 术语 | 说明 |
|------|------|
| 主人态 | 用户查看自己的个人主页时的视图状态 |
| 访客态 | 用户查看其他人的个人主页时的视图状态 |
| RLS | Row Level Security，Supabase的行级安全策略 |
| 动态 | 用户发起的抽奖活动（Giveaways） |
| 道具 | Roblox游戏中的虚拟物品（Items） |
| 宠物 | Roblox游戏中的宠物（Pets） |

### 13.3 设计稿与原型（待补充）
- [ ] 设计稿链接
- [ ] 交互原型链接
- [ ] UI组件库链接

### 13.4 更新日志
| 版本 | 日期 | 更新内容 | 作者 |
|------|------|---------|------|
| 1.0 | 2024-11-30 | 初始版本，完整PRD | - |

---

**PRD编写完成时间**：2024-11-30
**预计开发周期**：2-3周
**预计上线时间**：2024-12-下旬
