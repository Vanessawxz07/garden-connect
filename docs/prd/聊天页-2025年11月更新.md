# 聊天页 - 2025年11月更新

> 本文档记录聊天页的现网版本需求，作为后续新游戏拓展专项的基线参考。

---

## 一、页面概述

聊天页是交易双方沟通的核心页面，支持实时消息、交易状态同步和安全提示。

---

## 二、页面结构

### 2.1 整体布局

**桌面端：**
- 左侧：会话列表
- 右侧：聊天主区域

**移动端：**
- 会话列表页和聊天页分开
- 通过路由切换

### 2.2 会话列表

**列表项内容：**
- 对方头像
- 对方用户名
- 最后一条消息预览
- 最后消息时间
- 未读消息数量气泡
- 在线状态指示

**列表排序：**
- 按最后消息时间降序
- 未读消息优先（可选）

**列表筛选：**
- 全部会话
- 未读会话
- 已归档会话

### 2.3 聊天主区域

**头部信息：**
- 对方头像和用户名
- 在线状态
- 关联订单信息（订单ID、状态、快速跳转）
- 更多操作（举报、屏蔽、归档）

**消息区域：**
- 消息列表（时间正序）
- 消息气泡（区分自己/对方）
- 时间分隔线
- 滚动加载历史消息

**输入区域：**
- 文本输入框
- 发送按钮
- 表情选择（可选）
- 图片发送（可选）

---

## 三、消息类型

### 3.1 文本消息

**发送方消息：**
- 右侧对齐
- 主题色背景
- 发送时间
- 发送状态（发送中/已发送/已读）

**接收方消息：**
- 左侧对齐
- 次要色背景
- 接收时间

### 3.2 系统消息

**订单状态变更：**
- 居中显示
- 特殊样式（浅背景、小字号）
- 内容示例：
  - "Trade #12345 status changed to Trading"
  - "You accepted the offer from @username"
  - "Trade completed successfully"

**安全提示：**
- 醒目样式（警告色边框）
- 防诈骗提醒
- 不要在游戏外交易的警告

### 3.3 交易卡片消息（可选）

**场景：**
- 发送订单链接时自动转为卡片
- 显示订单摘要信息

**卡片内容：**
- 订单ID
- Have/Want道具预览
- 订单状态
- 点击跳转订单详情

---

## 四、功能说明

### 4.1 实时消息

**实时推送：**
- WebSocket连接
- 新消息即时显示
- 连接断开自动重连

**消息状态：**
- 发送中（loading）
- 已发送（单勾）
- 已送达（双勾）
- 已读（蓝色双勾，可选）

### 4.2 消息通知

**站内通知：**
- 页面内新消息提示
- 浏览器Tab标题闪烁
- 未读数量显示

**浏览器通知：**
- 请求通知权限
- 后台收到消息时推送
- 点击通知跳转聊天

### 4.3 历史消息

**加载方式：**
- 首次加载最近N条
- 向上滚动加载更多
- 加载完成后滚动位置保持

**消息存储：**
- 服务端永久存储
- 本地缓存加速加载

### 4.4 安全功能

**防诈骗提醒：**
- 首次聊天显示安全提示
- 定期显示提醒（可关闭）
- 检测可疑关键词预警

**举报功能：**
- 举报按钮入口
- 举报原因选择
- 举报消息截图
- 提交后反馈

**屏蔽功能：**
- 屏蔽用户按钮
- 屏蔽后无法收发消息
- 可在设置中管理屏蔽列表

---

## 五、订单关联

### 5.1 关联订单显示

**头部订单信息：**
- 订单ID（可点击跳转）
- 当前状态
- Have/Want摘要

**状态同步：**
- 订单状态变更实时同步
- 显示系统消息通知

### 5.2 交易操作入口

**快捷操作：**
- 确认交易完成
- 取消交易
- 查看订单详情

**操作确认：**
- 关键操作二次确认
- 操作结果反馈

---

## 六、交互细节

### 6.1 输入交互

**输入框：**
- 自动增高（最多N行）
- Enter发送，Shift+Enter换行
- 字数限制和提示

**发送按钮：**
- 空内容禁用
- 发送中loading状态
- 发送成功清空输入框

### 6.2 消息列表交互

**滚动行为：**
- 新消息自动滚动到底部
- 用户在查看历史时不自动滚动
- "跳转最新"悬浮按钮

**长按/右键菜单：**
- 复制消息
- 举报消息
- 删除消息（自己的）

### 6.3 会话列表交互

**滑动操作（移动端）：**
- 左滑显示操作按钮
- 归档/删除会话

**点击操作：**
- 点击进入聊天
- 标记已读

---

## 七、响应式设计

### 7.1 桌面端

**布局：**
- 左侧会话列表（固定宽度）
- 右侧聊天区域（自适应）
- 可拖拽调整宽度

**特性：**
- 同时显示列表和聊天
- 快捷键支持

### 7.2 移动端

**布局：**
- 会话列表全屏
- 聊天页全屏
- 返回按钮切换

**特性：**
- 底部安全区域适配
- 键盘弹起适配
- 下拉刷新

---

## 八、性能优化

### 8.1 消息渲染

- 虚拟列表（大量消息时）
- 消息分批渲染
- 图片懒加载

### 8.2 连接优化

- WebSocket心跳保活
- 断线重连机制
- 离线消息同步

### 8.3 缓存策略

- 会话列表本地缓存
- 消息增量同步
- 图片CDN缓存

---

## 九、无障碍设计

### 9.1 键盘导航

- Tab键切换焦点
- Enter键发送消息
- Esc键关闭弹窗

### 9.2 屏幕阅读器

- 消息朗读顺序
- 状态变更播报
- 操作按钮标签
